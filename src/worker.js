let intervalId=null,beatsPerBar=4,counter=0;self.addEventListener("message",(event=>{if("start"===event.data.type){const bpm=event.data.bpm,beatsPerMeasure=event.data.beatsPerMeasure;let intervalCount=0,totalIntervalTime=0,previousTickTime=null,intervalMs=6e4/bpm,calculateIntervalTime=6e4/bpm,averageIntervalTime=intervalMs;intervalId=setInterval((()=>{if(null!==previousTickTime){const expectedTime=intervalMs,timeDifference=Date.now()-previousTickTime-expectedTime;let tickAdjustment=0;timeDifference>2?tickAdjustment=1:timeDifference>0?tickAdjustment=timeDifference/5:timeDifference<-2?tickAdjustment=-1:timeDifference<0&&(tickAdjustment=timeDifference/5),intervalMs=Math.round(intervalMs+tickAdjustment),intervalMs<10&&(intervalMs=10)}counter%beatsPerMeasure==0?postMessage({sound:"weaker-beat"}):postMessage({sound:"strong-beat"}),previousTickTime=Date.now(),counter=++counter%beatsPerMeasure,totalIntervalTime+=intervalMs,intervalCount++,averageIntervalTime=totalIntervalTime/intervalCount,(averageIntervalTime<calculateIntervalTime-1||averageIntervalTime>calculateIntervalTime+1)&&(intervalMs+=calculateIntervalTime-averageIntervalTime,totalIntervalTime=intervalMs*intervalCount,console.group("[Worker] Latency detected, adjusting..."),console.log("Tick played at: "+previousTickTime),console.log("Average Interval: "+averageIntervalTime.toFixed(2)),console.groupEnd("[Worker] Latency detected, adjusting..."))}),intervalMs),beatsPerBar=beatsPerMeasure}else"stop"===event.data.type&&clearInterval(intervalId)}));