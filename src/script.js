const audioCtx=new(window.AudioContext||window.webkitAudioContext),timeSignatureInput=document.getElementById("time-signature"),tempoTapperBtn=document.getElementById("tempoTapperBtn"),startStopBtn=document.getElementById("startStopBtn"),tickSound=document.getElementById("tick-sound"),display=document.getElementById("display"),bpmInput=document.getElementById("bpm"),worker=new Worker("src/worker.js");let debounceTimer,strongBeatPath,weakerBeatPath,strongBeatSound,weakerBeatSound,taps=[],isPlaying=!1,previousTapTime=0;function loadMetronomeSounds(){strongBeatPath=document.getElementById("strongBeat").getAttribute("src"),weakerBeatPath=document.getElementById("weakerBeat").getAttribute("src"),strongBeatSound=audioCtx.createBufferSource(),weakerBeatSound=audioCtx.createBufferSource(),unloadMetronomeSounds();const loadSound=url=>fetch(url).then((response=>response.arrayBuffer())).then((arrayBuffer=>audioCtx.decodeAudioData(arrayBuffer))).catch((error=>console.log(error)));loadSound(strongBeatPath).then((buffer=>{null===strongBeatSound.buffer&&(strongBeatSound.buffer=buffer,strongBeatSound.connect(audioCtx.destination))})),loadSound(weakerBeatPath).then((buffer=>{null===weakerBeatSound.buffer&&(weakerBeatSound.buffer=buffer,weakerBeatSound.connect(audioCtx.destination))}))}function unloadMetronomeSounds(){strongBeatSound&&null!==strongBeatSound.buffer&&(strongBeatSound.disconnect(),strongBeatSound.buffer=null),weakerBeatSound&&null!==weakerBeatSound.buffer&&(weakerBeatSound.disconnect(),weakerBeatSound.buffer=null)}function calculateIntervalTime(bpm){return 6e4/bpm}function playSound(bufferSource){const source=audioCtx.createBufferSource();source.buffer=bufferSource.buffer,source.connect(audioCtx.destination),source.start(0)}function startStop(){if(isPlaying)isPlaying=!1,worker.postMessage({type:"stop"}),startStopBtn.innerText="Start";else{const bpm=parseInt(bpmInput.value),beatsPerMeasure=parseInt(timeSignatureInput.value.split("/")[0]);if(bpm>=30&&bpm<=300){var tickSoundArr=document.getElementById("tick-sound").value.split("|");document.getElementById("strongBeat").src=tickSoundArr[0],document.getElementById("weakerBeat").src=tickSoundArr[1],loadMetronomeSounds(),worker.postMessage({type:"start",beatsPerMeasure:beatsPerMeasure,bpm:bpm}),startStopBtn.innerText="Stop"}beatsPerBar=beatsPerMeasure}}function handleInputChangeRestart(){isPlaying?(startStop(),startStop()):startStop()}function handleInputChangeStop(){isPlaying&&startStop()}function debounce(func,delay){clearTimeout(debounceTimer),debounceTimer=setTimeout(func,delay)}tickSound.addEventListener("change",(()=>{isPlaying&&startStop()})),worker.onmessage=function(event){isPlaying||(isPlaying=!0),"weaker-beat"===event.data.sound?playSound(weakerBeatSound):"strong-beat"===event.data.sound&&playSound(strongBeatSound)},tempoTapperBtn.addEventListener("click",(()=>{const currentTime=Date.now();if(0!==previousTapTime){const timeDifference=currentTime-previousTapTime,bpm=Math.round(6e4/timeDifference);taps.push(bpm),taps.length>5&&taps.shift();const averageBpm=Math.min(Math.round(taps.reduce(((a,b)=>a+b))/taps.length),300);bpmInput.value=averageBpm}previousTapTime=currentTime})),startStopBtn.addEventListener("click",(function(){debounce(startStop,500)})),bpmInput.addEventListener("input",(function(){debounce(handleInputChangeRestart,500)})),tempoTapperBtn.addEventListener("click",handleInputChangeStop),timeSignatureInput.addEventListener("input",handleInputChangeRestart);